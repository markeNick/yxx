<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yxx.dao.ChatMapper">
    <resultMap id="ChatResultMap" type="com.yxx.pojo.Chat">
        <result column="chat_id" property="chatId" />
        <result column="fromUser" property="fromUser" />
        <result column="toUser" property="toUser" />
        <result column="content" property="content" />
        <result column="theTime" property="theTime" />
    </resultMap>

    <resultMap id="ChatListResultMap" type="com.yxx.pojo.ChatList">
        <result column="chatList_id" property="chatListId" />
        <result column="A_openID" property="AOpenID" />
        <result column="B_openID" property="BOpenID" />
        <result column="modifyTime" property="modifyTime" />
    </resultMap>

    <!-- 查找离线聊天信息 -->
    <select id="selectChatMessage" resultType="com.yxx.pojo.Chat" parameterType="string">
        select * from chat
        where toUser = #{openID}
    </select>

    <!-- 删除离线聊天信息 -->
    <delete id="deleteChatMessage" parameterType="string">
        delete from chat
        where toUser = #{openID}
    </delete>

    <!-- 获取聊天列表 -->
    <select id="getChatList" resultType="com.yxx.pojo.ChatList">
        select c.*, u.user_name, u.user_image, g.status from chatList c, user u, goods g
        where u.openID = c.B_openID
        and g.goods_id = c.goods_id
        and A_openID = #{openID}
        order by modifyTime desc
        limit #{currentPage},15
    </select>

    <!-- 删除聊天列表 -->
    <delete id="deleteChatList">
        delete from chatList
        where A_openID = #{A_openID}
        and B_openID = #{B_openID}
        and goods_id = #{goodsID}
    </delete>

    <!-- 保存聊天记录 -->
    <insert id="insertChatMessage">
        insert into chat(fromUser, toUser, content, theTime)
        values(#{fromUser}, #{toUser}, #{content}, #{theTime})
    </insert>

    <!-- 增加聊天列表 -->
<!--    <insert id="insertChatList">-->
<!--        insert into chatList(A_openID, B_openID, goods_id, modifyTime)-->
<!--        select #{AOpenID}, #{BOpenID}, #{goodsID}, #{modifyTime}-->
<!--        from dual-->
<!--        where not exists(-->
<!--            select * from chatList-->
<!--            where A_openID = #{AOpenID}-->
<!--            and B_openID = #{BOpenID}-->
<!--            and goods_id = #{goodsID}-->
<!--            and modifyTime = #{modifyTime}-->
<!--        )-->
<!--    </insert>-->

    <!-- 增加聊天列表 -->
<!--    <insert id="insertChatList">-->
<!--        insert into chatList(A_openID, B_openID, goods_id, modifyTime, A_status, B_status)-->
<!--        values(#{AOpenID}, #{BOpenID}, #{goodsID}, #{modifyTime}, 0, 0)-->
<!--    </insert>-->

    <!-- 增加聊天列表 -->
    <insert id="insertChatList">
        insert into chatList(A_openID, B_openID, goods_id, modifyTime)
        values(#{AOpenID}, #{BOpenID}, #{goodsID}, #{modifyTime})
        on duplicate key update
        modifyTime = #{modifyTime}
    </insert>

    <!-- 上传聊天图片 -->
    <insert id="insertImage" parameterType="string">
        insert into image(image_name)
        values(#{imageName})
    </insert>
</mapper>